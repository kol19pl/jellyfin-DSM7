name: Ubuntu 18.04 with glibc 2.26 Build

on:
  push:
    branches:
      - master
  pull_request:

env:
  SDK_VERSION: "10.0.x"
  GLIBC_VERSION: "2.26"

jobs:
  build_glibc_2_26:
    runs-on: ubuntu-18.04

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            pkg-config \
            libsqlite3-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libharfbuzz-dev \
            libicu-dev \
            libjpeg-dev \
            libpng-dev \
            libwebp-dev \
            zlib1g-dev

      - name: Verify glibc version
        run: |
          ldd --version | grep -E "glibc|ldd"
          echo "GLIBC_VERSION=${GLIBC_VERSION}" >> $GITHUB_ENV

      - uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5.1.0
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Restore dependencies
        run: dotnet restore Jellyfin.sln

      - name: Build solution
        run: dotnet build Jellyfin.sln --configuration Release --no-restore

      - name: Test solution
        run: dotnet test Jellyfin.sln --configuration Release --no-build --verbosity normal
